{% extends "base.html" %}

{% block title %}Dashboard - ACEest Fitness{% endblock %}

{% block extra_css %}
<style>
    .stat-box {
        background-color: #4CAF50;
        color: white;
        padding: 20px;
        border-radius: 5px;
        text-align: center;
    }
    
    .stat-box h3 {
        color: white;
        font-size: 32px;
        margin: 10px 0;
    }
    
    .stat-box p {
        color: white;
        margin: 0;
        font-size: 14px;
    }
</style>
{% endblock %}

{% block content %}
<h2>Dashboard</h2>

<!-- User Info Card -->
<div class="card">
    <h3>Welcome, {{ user.name }}!</h3>
    <p><strong>Registration ID:</strong> {{ user.regn_id }}</p>
    <p><strong>BMI:</strong> {{ user.bmi }} | <strong>BMR:</strong> {{ user.bmr }} kcal/day</p>
</div>

<!-- Statistics -->
<div class="grid" style="grid-template-columns: repeat(4, 1fr);">
    <div class="stat-box">
        <p>Total Time</p>
        <h3 id="totalTime">0</h3>
        <p>minutes</p>
    </div>
    
    <div class="stat-box" style="background-color: #2196F3;">
        <p>Total Calories</p>
        <h3 id="totalCalories">0</h3>
        <p>kcal burned</p>
    </div>
    
    <div class="stat-box" style="background-color: #FF9800;">
        <p>Sessions</p>
        <h3 id="totalSessions">0</h3>
        <p>workouts</p>
    </div>
    
    <div class="stat-box" style="background-color: #9C27B0;">
        <p>Last Workout</p>
        <h3 id="lastWorkout" style="font-size: 18px;">None</h3>
    </div>
</div>

<!-- Main Content Area -->
<div class="grid" style="margin-top: 30px;">
    <!-- Add Workout Form -->
    <div class="card">
        <h3>Log Workout Session</h3>
        <form id="workoutForm">
            <div class="form-group">
                <label for="category">Category</label>
                <select id="category" required>
                    <option value="Warm-up">Warm-up</option>
                    <option value="Workout" selected>Workout</option>
                    <option value="Cool-down">Cool-down</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="exercise">Exercise Name</label>
                <input type="text" id="exercise" placeholder="e.g., Push-ups, Running" required>
            </div>
            
            <div class="form-group">
                <label for="duration">Duration (minutes)</label>
                <input type="number" id="duration" min="1" required>
            </div>
            
            <button type="submit" class="btn btn-primary" style="width: 100%;">Add Session</button>
        </form>
    </div>

    <!-- Progress Chart -->
    <div class="card">
        <h3>Progress Chart</h3>
        <canvas id="progressChart" width="400" height="250"></canvas>
    </div>
</div>

<!-- Workout History -->
<div class="card" style="margin-top: 30px;">
    <h3>Workout History</h3>
    <div id="workoutHistory">
        <p style="text-align: center; color: #666; padding: 20px;">No workouts logged yet. Start by adding your first session above!</p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
let progressChart = null;

async function loadWorkoutData() {
    try {
        const response = await fetch('/api/workout/summary');
        const data = await response.json();
        
        document.getElementById('totalTime').textContent = data.total_time;
        document.getElementById('totalCalories').textContent = data.total_calories;
        document.getElementById('totalSessions').textContent = data.session_count;
        
        updateWorkoutHistory(data.categories);
        await updateChart();
    } catch (error) {
        console.error('Error:', error);
    }
}

function updateWorkoutHistory(categories) {
    const historyDiv = document.getElementById('workoutHistory');
    let html = '<table><tr><th>Category</th><th>Exercise</th><th>Duration</th><th>Calories</th><th>Date</th></tr>';
    
    let hasWorkouts = false;
    for (const [category, data] of Object.entries(categories)) {
        if (data.sessions.length > 0) {
            hasWorkouts = true;
            data.sessions.slice(-10).reverse().forEach(session => {
                const date = new Date(session.timestamp).toLocaleString();
                html += `<tr>
                    <td>${category}</td>
                    <td>${session.exercise}</td>
                    <td>${session.duration} min</td>
                    <td>${session.calories} kcal</td>
                    <td>${date}</td>
                </tr>`;
            });
        }
    }
    html += '</table>';
    
    if (!hasWorkouts) {
        html = '<p style="text-align: center; color: #666; padding: 20px;">No workouts logged yet.</p>';
    }
    
    historyDiv.innerHTML = html;
}

async function updateChart() {
    try {
        const response = await fetch('/api/workout/progress');
        const data = await response.json();
        
        const ctx = document.getElementById('progressChart').getContext('2d');
        
        if (progressChart) {
            progressChart.destroy();
        }
        
        progressChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.categories,
                datasets: [{
                    label: 'Duration (minutes)',
                    data: data.durations,
                    backgroundColor: ['#2196F3', '#4CAF50', '#FF9800']
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    } catch (error) {
        console.error('Error:', error);
    }
}

document.getElementById('workoutForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = {
        category: document.getElementById('category').value,
        exercise: document.getElementById('exercise').value,
        duration: document.getElementById('duration').value
    };
    
    try {
        const response = await fetch('/api/workout/add', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(formData)
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('Workout added! Calories burned: ' + result.calories + ' kcal');
            document.getElementById('workoutForm').reset();
            loadWorkoutData();
        } else {
            alert('Error: ' + result.message);
        }
    } catch (error) {
        alert('An error occurred.');
    }
});

document.addEventListener('DOMContentLoaded', loadWorkoutData);
</script>
{% endblock %}
